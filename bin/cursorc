#!/bin/bash
# Open Cursor with colors based on worktree path

#set -e

readonly WORKSPACE_DIR="${CURSOR_WORKSPACES:-$HOME/.cursor-workspaces}"
readonly CURSOR_CMD="${CURSOR_CMD:-cursor}"

# Colors for random assignment
readonly RANDOM_COLORS=("#2e5252" "#b35426" "#5e4a6e" "#335673" "#8b3a3a" "#52522e" "#6e4a5e" "#4a6e5e" "#73563c" "#4a5e6e")

get_color() {
    local worktree="$1"
    # Use predefined colors for specific worktree types
    case "$worktree" in
        review)     echo "#1a3d1a" ;;
        reference)  echo "#1a2847" ;;
        hotfix)     echo "#3d1a1a" ;;
        secondary)  echo "#3d1a3d" ;;
        *)  # Deterministic random color based on worktree name
            local seed=$(echo -n "$worktree" | cksum | cut -d' ' -f1)
            echo "${RANDOM_COLORS[$((seed % ${#RANDOM_COLORS[@]}))]}"
            ;;
    esac
}

extract_worktree() {
    # Extract worktree name from path like .../trees/{worktree}/...
    local path="$1"
    [[ "$path" =~ /trees/([^/]+) ]] && echo "${BASH_REMATCH[1]}"
}

extract_area() {
    # Extract area/library name from paths
    local path="$1"
    if [[ "$path" =~ /src/(areas|libraries)/[^/]+/([^/]+) ]]; then
        echo "${BASH_REMATCH[2]}"
    fi
}

open_cursor() {
    if command -v "$CURSOR_CMD" &>/dev/null; then
        "$CURSOR_CMD" "$@"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        open -a "Cursor" "$@"
    else
        echo "Error: cursor command not found" >&2
        exit 1
    fi
}

create_workspace() {
    local dir="$1" color="$2" file="$3"
    local name="${dir##*/}"

    cat > "$file" << EOF
{
  "folders": [{"path": "$dir", "name": "$name"}],
  "settings": {
    "workbench.colorCustomizations": {
      "activityBar.activeBackground": "$color",
      "activityBar.background": "$color",
      "activityBar.foreground": "#ffffff",
      "activityBar.inactiveForeground": "#ffffff99",
      "activityBarBadge.background": "#ffffff",
      "activityBarBadge.foreground": "#000000",
      "statusBar.background": "$color",
      "statusBar.foreground": "#ffffff",
      "statusBarItem.hoverBackground": "#ffffff22",
      "titleBar.activeBackground": "$color",
      "titleBar.activeForeground": "#ffffff",
      "titleBar.inactiveBackground": "$color",
      "titleBar.inactiveForeground": "#ffffff99"
    }
  }
}
EOF
}

# Main logic
if [[ $# -eq 0 ]]; then
    target_dir="$(pwd)"
else
    target_dir="$1"
    shift  # Shift off the directory argument, keep remaining args
fi
target_dir=$(cd "$target_dir" 2>/dev/null && pwd) || {
    echo "Error: Invalid directory" >&2
    exit 1
}

worktree=$(extract_worktree "$target_dir")

# Open directly if no worktree or root worktree
if [[ -z "$worktree" || "$worktree" == "root" ]]; then
    open_cursor "$target_dir" "$@"
    exit 0
fi

# Generate workspace file with color
mkdir -p "$WORKSPACE_DIR"

area=$(extract_area "$target_dir")
workspace_name="${area:-${target_dir##*/}}_${worktree}"
workspace_file="$WORKSPACE_DIR/${workspace_name}.code-workspace"

# Regenerate workspace if script is newer
if [[ ! -f "$workspace_file" || "$0" -nt "$workspace_file" ]]; then
    create_workspace "$target_dir" "$(get_color "$worktree")" "$workspace_file"
fi

open_cursor "$workspace_file" "$@"
